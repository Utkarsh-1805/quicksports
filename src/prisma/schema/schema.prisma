// Main Prisma schema file - contains datasource and generator configurations

generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

// ==================== ENUMS ====================

enum Role {
  USER
  FACILITY_OWNER
  ADMIN
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum FacilityStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SportType {
  BADMINTON
  TENNIS
  FOOTBALL
  CRICKET
  BASKETBALL
  TABLE_TENNIS
  SWIMMING
  SQUASH
  VOLLEYBALL
  OTHER
}

enum OtpType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentMethod {
  CARD
  UPI
  NET_BANKING
  WALLET
  EMI
}

enum RefundStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

// ==================== USER & AUTH ====================

model User {
  id         String   @id @default(cuid())
  email      String   @unique
  password   String
  name       String
  phone      String?
  role       Role     @default(USER)
  isVerified Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  facilities Facility[] // Facilities owned by this user (for OWNER role)
  bookings   Booking[]  // Bookings made by this user
  otps       Otp[]      // OTPs generated for this user
  reviews    Review[]   // Reviews written by this user
  payments   Payment[]  // Payments made by this user
  refunds    Refund[]   // Refunds received by this user

  @@map("users")
}

model Otp {
  id        String   @id @default(cuid())
  code      String
  type      OtpType
  expiresAt DateTime
  isUsed    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
  @@index([expiresAt])
  @@map("otps")
}

// ==================== FACILITY ====================

model Facility {
  id          String         @id @default(cuid())
  name        String
  description String?
  address     String
  city        String
  state       String
  pincode     String
  latitude    Float?
  longitude   Float?
  status      FacilityStatus @default(PENDING)
  adminNote   String?        // Admin comments on approval/rejection
  approvedAt  DateTime?      // When venue was approved/rejected
  approvedBy  String?        // Admin user ID who approved/rejected
  
  // Owner relation
  ownerId     String
  owner       User           @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  amenities   FacilityAmenity[]
  photos      FacilityPhoto[]
  courts      Court[]
  reviews     Review[]

  @@map("facilities")
}

model FacilityPhoto {
  id         String   @id @default(cuid())
  url        String
  caption    String?
  facilityId String
  facility   Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@map("facility_photos")
}

model Amenity {
  id          String            @id @default(cuid())
  name        String            @unique
  icon        String?
  facilities  FacilityAmenity[]

  @@map("amenities")
}

model FacilityAmenity {
  facilityId String
  amenityId  String
  facility   Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  amenity    Amenity  @relation(fields: [amenityId], references: [id], onDelete: Cascade)

  @@id([facilityId, amenityId])
  @@map("facility_amenities")
}

// ==================== COURT ====================

model Court {
  id            String    @id @default(cuid())
  name          String
  description   String?
  sportType     SportType
  pricePerHour  Float
  isActive      Boolean   @default(true)
  
  // Operating hours (stored as "HH:MM" format)
  openingTime   String    @default("06:00")
  closingTime   String    @default("22:00")
  
  facilityId    String
  facility      Facility  @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  timeSlots     TimeSlot[]
  bookings      Booking[]

  @@map("courts")
}

// ==================== TIME SLOT ====================

model TimeSlot {
  id          String   @id @default(cuid())
  date        DateTime @db.Date
  startTime   String   // "HH:MM" format
  endTime     String   // "HH:MM" format
  isBlocked   Boolean  @default(false) // For maintenance
  blockReason String?
  
  courtId     String
  court       Court    @relation(fields: [courtId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())

  // Relations
  booking     Booking?

  @@unique([courtId, date, startTime])
  @@map("time_slots")
}

// ==================== BOOKING ====================

model Booking {
  id            String        @id @default(cuid())
  bookingDate   DateTime      @db.Date
  startTime     String        // "HH:MM" format
  endTime       String        // "HH:MM" format
  duration      Int           @default(60) // Duration in minutes, default 1 hour
  totalAmount   Float
  status        BookingStatus @default(PENDING)
  
  // Booking lifecycle timestamps
  confirmedAt      DateTime?
  cancelledAt      DateTime?
  cancellationReason String?
  
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  courtId       String
  court         Court         @relation(fields: [courtId], references: [id], onDelete: Cascade)
  
  timeSlotId    String?       @unique
  timeSlot      TimeSlot?     @relation(fields: [timeSlotId], references: [id], onDelete: SetNull)
  
  // Payment Relations
  payment       Payment?      // Payment for this booking
  refunds       Refund[]      // Refunds for this booking
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@map("bookings")
}

// ==================== REVIEW ====================

model Review {
  id          String   @id @default(cuid())
  rating      Int      // 1-5
  comment     String?
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  facilityId  String
  facility    Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, facilityId]) // One review per user per facility
  @@map("reviews")
}

// ==================== PAYMENT ====================

model Payment {
  id                  String        @id @default(cuid())
  bookingId           String        @unique
  booking             Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  userId              String
  user                User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Payment Gateway Details
  razorpayOrderId     String        @unique
  razorpayPaymentId   String?       @unique
  
  // Amount Details
  amount              Float         // Original booking amount
  processingFee       Float         // Payment processing fee
  gst                 Float         // GST on processing fee
  totalAmount         Float         // Final amount charged
  currency            String        @default("INR")
  
  // Payment Details
  method              PaymentMethod
  status              PaymentStatus @default(PENDING)
  
  // Gateway Response
  gatewayResponse     Json?         // Full gateway response for debugging
  failureReason       String?       // Failure reason if payment failed
  
  // Metadata
  notes               Json?         // Additional notes/metadata
  
  // Timestamps
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  completedAt         DateTime?     // When payment was completed
  webhookProcessedAt  DateTime?     // When webhook was processed
  
  // Relations
  refunds             Refund[]
  
  @@map("payments")
}

// ==================== REFUND ====================

model Refund {
  id                String       @id @default(cuid())
  
  paymentId         String
  payment           Payment      @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  
  bookingId         String
  booking           Booking      @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  
  userId            String
  user              User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Refund Gateway Details
  razorpayRefundId  String?      @unique
  
  // Amount Details
  amount            Float        // Refund amount
  originalAmount    Float        // Original payment amount
  refundPercentage  Int          // Percentage of original amount refunded
  
  // Refund Details
  status            RefundStatus @default(PENDING)
  reason            String       // Reason for refund
  
  // Metadata
  notes             Json?        // Additional notes/metadata
  
  // Timestamps
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  processedAt       DateTime?    // When refund was processed
  
  @@map("refunds")
}