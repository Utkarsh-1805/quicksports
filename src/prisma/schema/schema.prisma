generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                 String         @id @default(cuid())
  email              String         @unique
  password           String
  name               String
  phone              String?
  role               Role           @default(USER)
  isVerified         Boolean        @default(false)
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  avatar             String?
  bio                String?
  deactivatedAt      DateTime?
  deactivationReason String?
  isActive           Boolean        @default(true)
  lastLoginAt        DateTime?
  preferences        Json?
  bookings           Booking[]
  facilities         Facility[]
  notifications      Notification[]
  otps               Otp[]
  payments           Payment[]
  refunds            Refund[]
  reviews            Review[]
  reports            Report[]

  @@map("users")
}

model Otp {
  id        String   @id @default(cuid())
  code      String
  type      OtpType
  expiresAt DateTime
  isUsed    Boolean  @default(false)
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
  @@index([expiresAt])
  @@map("otps")
}

model Facility {
  id          String            @id @default(cuid())
  name        String
  description String?
  address     String
  city        String
  state       String
  pincode     String
  latitude    Float?
  longitude   Float?
  status      FacilityStatus    @default(PENDING)
  adminNote   String?
  ownerId     String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  approvedAt  DateTime?
  approvedBy  String?
  courts      Court[]
  owner       User              @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  amenities   FacilityAmenity[]
  photos      FacilityPhoto[]
  reviews     Review[]

  @@map("facilities")
}

model FacilityPhoto {
  id         String   @id @default(cuid())
  url        String
  caption    String?
  facilityId String
  createdAt  DateTime @default(now())
  facility   Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  @@map("facility_photos")
}

model Amenity {
  id         String            @id @default(cuid())
  name       String            @unique
  icon       String?
  facilities FacilityAmenity[]

  @@map("amenities")
}

model FacilityAmenity {
  facilityId String
  amenityId  String
  amenity    Amenity  @relation(fields: [amenityId], references: [id], onDelete: Cascade)
  facility   Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)

  @@id([facilityId, amenityId])
  @@map("facility_amenities")
}

model Court {
  id           String     @id @default(cuid())
  name         String
  description  String?
  sportType    SportType
  pricePerHour Float
  isActive     Boolean    @default(true)
  openingTime  String     @default("06:00")
  closingTime  String     @default("22:00")
  facilityId   String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  bookings     Booking[]
  facility     Facility   @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  timeSlots    TimeSlot[]

  @@map("courts")
}

model TimeSlot {
  id          String   @id @default(cuid())
  date        DateTime @db.Date
  startTime   String
  endTime     String
  isBlocked   Boolean  @default(false)
  blockReason String?
  courtId     String
  createdAt   DateTime @default(now())
  booking     Booking?
  court       Court    @relation(fields: [courtId], references: [id], onDelete: Cascade)

  @@unique([courtId, date, startTime])
  @@map("time_slots")
}

model Booking {
  id                 String        @id @default(cuid())
  bookingDate        DateTime      @db.Date
  startTime          String
  endTime            String
  totalAmount        Float
  status             BookingStatus @default(PENDING)
  userId             String
  courtId            String
  timeSlotId         String?       @unique
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  cancellationReason String?
  cancelledAt        DateTime?
  confirmedAt        DateTime?
  duration           Int           @default(60)
  court              Court         @relation(fields: [courtId], references: [id], onDelete: Cascade)
  timeSlot           TimeSlot?     @relation(fields: [timeSlotId], references: [id])
  user               User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  payment            Payment?
  refunds            Refund[]

  @@map("bookings")
}

model Review {
  id                String    @id @default(cuid())
  rating            Int
  comment           String?
  userId            String
  facilityId        String
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  flagReason        String?
  flaggedAt         DateTime?
  flaggedBy         String?
  helpfulCount      Int       @default(0)
  helpfulVoters     Json?
  isApproved        Boolean   @default(true)
  isFlagged         Boolean   @default(false)
  isVerifiedBooking Boolean   @default(false)
  moderatedAt       DateTime?
  moderatedBy       String?
  ownerRespondedAt  DateTime?
  ownerResponse     String?
  title             String?
  facility          Facility  @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  user              User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, facilityId])
  @@index([facilityId])
  @@index([isApproved])
  @@index([isFlagged])
  @@map("reviews")
}

model Payment {
  id                 String        @id @default(cuid())
  bookingId          String        @unique
  userId             String
  razorpayOrderId    String        @unique
  razorpayPaymentId  String?       @unique
  amount             Float
  processingFee      Float
  gst                Float
  totalAmount        Float
  currency           String        @default("INR")
  method             PaymentMethod
  status             PaymentStatus @default(PENDING)
  gatewayResponse    Json?
  failureReason      String?
  notes              Json?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  completedAt        DateTime?
  webhookProcessedAt DateTime?
  booking            Booking       @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  user               User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  refunds            Refund[]

  @@map("payments")
}

model Refund {
  id               String       @id @default(cuid())
  paymentId        String
  bookingId        String
  userId           String
  razorpayRefundId String?      @unique
  amount           Float
  originalAmount   Float
  refundPercentage Int
  status           RefundStatus @default(PENDING)
  reason           String
  notes            Json?
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  processedAt      DateTime?
  booking          Booking      @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  payment          Payment      @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  user             User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("refunds")
}

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?
  isRead    Boolean          @default(false)
  readAt    DateTime?
  emailSent Boolean          @default(false)
  smsSent   Boolean          @default(false)
  pushSent  Boolean          @default(false)
  createdAt DateTime         @default(now())
  expiresAt DateTime?
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([createdAt])
  @@index([isRead])
  @@map("notifications")
}

enum Role {
  USER
  FACILITY_OWNER
  ADMIN
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum FacilityStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SportType {
  BADMINTON
  TENNIS
  FOOTBALL
  CRICKET
  BASKETBALL
  TABLE_TENNIS
  SWIMMING
  SQUASH
  VOLLEYBALL
  OTHER
}

enum OtpType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentMethod {
  CARD
  UPI
  NET_BANKING
  WALLET
  EMI
}

enum RefundStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
}

enum NotificationType {
  BOOKING_CONFIRMED
  BOOKING_CANCELLED
  BOOKING_REMINDER
  PAYMENT_SUCCESS
  PAYMENT_FAILED
  REFUND_PROCESSED
  REVIEW_RESPONSE
  VENUE_APPROVED
  VENUE_REJECTED
  SYSTEM_ALERT
  PROMOTIONAL
}

model Report {
  id          String       @id @default(cuid())
  reporterId  String
  targetType  ReportType
  targetId    String
  category    ReportCategory
  title       String
  description String
  evidence    Json?        // Array of URLs to evidence
  priority    ReportPriority @default(MEDIUM)
  status      ReportStatus @default(PENDING)
  resolution  String?
  resolvedAt  DateTime?
  resolvedBy  String?
  metadata    Json?        // Additional context data
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  
  reporter    User         @relation(fields: [reporterId], references: [id], onDelete: Cascade)
  
  @@index([reporterId])
  @@index([targetType, targetId])
  @@index([status])
  @@index([priority])
  @@map("reports")
}

enum ReportType {
  FACILITY
  USER
  BOOKING
  REVIEW
  OTHER
}

enum ReportCategory {
  INAPPROPRIATE_CONTENT
  FAKE_INFORMATION
  POOR_SERVICE
  BOOKING_DISPUTE
  HARASSMENT
  SPAM
  FRAUD
  SAFETY_CONCERN
  OTHER
}

enum ReportPriority {
  LOW
  MEDIUM
  HIGH
}

enum ReportStatus {
  PENDING
  INVESTIGATING
  RESOLVED
  DISMISSED
}
