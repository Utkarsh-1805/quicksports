// Main Prisma schema file - contains datasource and generator configurations

generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
}

// ==================== ENUMS ====================

enum Role {
  USER
  FACILITY_OWNER
  ADMIN
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum FacilityStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SportType {
  BADMINTON
  TENNIS
  FOOTBALL
  CRICKET
  BASKETBALL
  TABLE_TENNIS
  SWIMMING
  SQUASH
  VOLLEYBALL
  OTHER
}

enum OtpType {
  EMAIL_VERIFICATION
  PASSWORD_RESET
}

// ==================== USER & AUTH ====================

model User {
  id         String   @id @default(cuid())
  email      String   @unique
  password   String
  name       String
  phone      String?
  role       Role     @default(USER)
  isVerified Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  facilities Facility[] // Facilities owned by this user (for OWNER role)
  bookings   Booking[]  // Bookings made by this user
  otps       Otp[]      // OTPs generated for this user
  reviews    Review[]   // Reviews written by this user

  @@map("users")
}

model Otp {
  id        String   @id @default(cuid())
  code      String
  type      OtpType
  expiresAt DateTime
  isUsed    Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([code])
  @@index([expiresAt])
  @@map("otps")
}

// ==================== FACILITY ====================

model Facility {
  id          String         @id @default(cuid())
  name        String
  description String?
  address     String
  city        String
  state       String
  pincode     String
  latitude    Float?
  longitude   Float?
  status      FacilityStatus @default(PENDING)
  adminNote   String?        // Admin comments on approval/rejection
  
  // Owner relation
  ownerId     String
  owner       User           @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  // Relations
  amenities   FacilityAmenity[]
  photos      FacilityPhoto[]
  courts      Court[]
  reviews     Review[]

  @@map("facilities")
}

model FacilityPhoto {
  id         String   @id @default(cuid())
  url        String
  caption    String?
  facilityId String
  facility   Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@map("facility_photos")
}

model Amenity {
  id          String            @id @default(cuid())
  name        String            @unique
  icon        String?
  facilities  FacilityAmenity[]

  @@map("amenities")
}

model FacilityAmenity {
  facilityId String
  amenityId  String
  facility   Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  amenity    Amenity  @relation(fields: [amenityId], references: [id], onDelete: Cascade)

  @@id([facilityId, amenityId])
  @@map("facility_amenities")
}

// ==================== COURT ====================

model Court {
  id            String    @id @default(cuid())
  name          String
  description   String?
  sportType     SportType
  pricePerHour  Float
  isActive      Boolean   @default(true)
  
  // Operating hours (stored as "HH:MM" format)
  openingTime   String    @default("06:00")
  closingTime   String    @default("22:00")
  
  facilityId    String
  facility      Facility  @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relations
  timeSlots     TimeSlot[]
  bookings      Booking[]

  @@map("courts")
}

// ==================== TIME SLOT ====================

model TimeSlot {
  id          String   @id @default(cuid())
  date        DateTime @db.Date
  startTime   String   // "HH:MM" format
  endTime     String   // "HH:MM" format
  isBlocked   Boolean  @default(false) // For maintenance
  blockReason String?
  
  courtId     String
  court       Court    @relation(fields: [courtId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())

  // Relations
  booking     Booking?

  @@unique([courtId, date, startTime])
  @@map("time_slots")
}

// ==================== BOOKING ====================

model Booking {
  id            String        @id @default(cuid())
  bookingDate   DateTime      @db.Date
  startTime     String        // "HH:MM" format
  endTime       String        // "HH:MM" format
  totalAmount   Float
  status        BookingStatus @default(PENDING)
  paymentId     String?       // Simulated payment reference
  
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  courtId       String
  court         Court         @relation(fields: [courtId], references: [id], onDelete: Cascade)
  
  timeSlotId    String?       @unique
  timeSlot      TimeSlot?     @relation(fields: [timeSlotId], references: [id], onDelete: SetNull)
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@map("bookings")
}

// ==================== REVIEW ====================

model Review {
  id          String   @id @default(cuid())
  rating      Int      // 1-5
  comment     String?
  
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  facilityId  String
  facility    Facility @relation(fields: [facilityId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, facilityId]) // One review per user per facility
  @@map("reviews")
}